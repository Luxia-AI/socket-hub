# =============================================================================
# Trigger Infra Deployment on Push
# =============================================================================
# This workflow triggers the infra repo deployment when changes are pushed
# to the main branch of socket-hub.
#
# Required Secret:
#   INFRA_DISPATCH_TOKEN - A GitHub Personal Access Token (PAT) with:
#     - repo scope (or fine-grained: contents:write on Luxia-AI/infra)
#   Create this secret in: Settings > Secrets and variables > Actions
# =============================================================================

name: Trigger Infra Deploy

on:
  push:
    branches:
      - main

jobs:
  trigger-deploy:
    name: Trigger Infra Workflow
    runs-on: ubuntu-latest

    steps:
      - name: Log dispatch info
        run: |
          echo "=========================================="
          echo "Triggering infra deployment"
          echo "=========================================="
          echo "Service: socket-hub"
          echo "Commit: ${{ github.sha }}"
          echo "Ref: ${{ github.ref }}"
          echo "=========================================="

      - name: Dispatch to infra repo
        env:
          GITHUB_TOKEN: ${{ secrets.INFRA_DISPATCH_TOKEN }}
        run: |
          HTTP_CODE=$(curl -s -o response.txt -w "%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/Luxia-AI/infra/dispatches \
            -d '{"event_type":"service-updated","client_payload":{"service":"socket-hub","sha":"${{ github.sha }}"}}')

          echo "HTTP Status: $HTTP_CODE"
          if [ -s response.txt ]; then
            echo "Response:"
            cat response.txt
          fi

          if [ "$HTTP_CODE" -eq 204 ]; then
            echo "Dispatch sent successfully"
          else
            echo "ERROR: Dispatch failed with status $HTTP_CODE"
            exit 1
          fi
